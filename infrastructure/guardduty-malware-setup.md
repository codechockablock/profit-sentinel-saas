# AWS GuardDuty S3 Malware Protection Setup

This document provides instructions for setting up AWS GuardDuty S3 Malware Protection
for the Profit Sentinel upload bucket.

## Prerequisites

- AWS CLI configured with appropriate permissions
- GuardDuty enabled in your AWS account
- S3 bucket: `profitsentinel-dev-uploads` (or your production bucket name)

## Option 1: AWS CLI Setup

### 1. Enable GuardDuty (if not already enabled)

```bash
# Enable GuardDuty detector
aws guardduty create-detector --enable --finding-publishing-frequency FIFTEEN_MINUTES
```

### 2. Get your detector ID

```bash
# List detectors to get the ID
aws guardduty list-detectors
```

### 3. Enable S3 Malware Protection

```bash
# Replace DETECTOR_ID with your actual detector ID
# Replace BUCKET_NAME with your S3 bucket name

aws guardduty update-malware-scan-settings \
  --detector-id DETECTOR_ID \
  --scan-resource-criteria '{"Include": {"S3BucketCriteria": {"BucketName": ["profitsentinel-dev-uploads"]}}}'
```

### 4. Verify configuration

```bash
aws guardduty get-malware-scan-settings --detector-id DETECTOR_ID
```

## Option 2: Terraform Configuration

```hcl
# Enable GuardDuty
resource "aws_guardduty_detector" "main" {
  enable = true
  finding_publishing_frequency = "FIFTEEN_MINUTES"

  datasources {
    s3_logs {
      enable = true
    }
    malware_protection {
      scan_ec2_instance_with_findings {
        ebs_volumes {
          enable = true
        }
      }
    }
  }
}

# Enable S3 Malware Protection for uploads bucket
resource "aws_guardduty_malware_protection_plan" "uploads" {
  detector_id = aws_guardduty_detector.main.id

  protected_resource {
    s3_bucket {
      bucket_name = "profitsentinel-dev-uploads"
    }
  }

  actions {
    tagging {
      status = "ENABLED"
    }
  }

  role_arn = aws_iam_role.guardduty_malware.arn
}

# IAM role for GuardDuty to scan S3 objects
resource "aws_iam_role" "guardduty_malware" {
  name = "guardduty-malware-protection-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "malware-protection.guardduty.amazonaws.com"
        }
      }
    ]
  })
}

resource "aws_iam_role_policy" "guardduty_malware" {
  name = "guardduty-malware-s3-access"
  role = aws_iam_role.guardduty_malware.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "s3:GetObject",
          "s3:GetObjectTagging",
          "s3:PutObjectTagging"
        ]
        Resource = "arn:aws:s3:::profitsentinel-dev-uploads/*"
      },
      {
        Effect = "Allow"
        Action = [
          "s3:ListBucket"
        ]
        Resource = "arn:aws:s3:::profitsentinel-dev-uploads"
      }
    ]
  })
}
```

## Option 3: AWS Console

1. Navigate to **GuardDuty** in AWS Console
2. Go to **Malware Protection** â†’ **S3 Malware Protection**
3. Click **Enable S3 Malware Protection**
4. Select your upload bucket: `profitsentinel-dev-uploads`
5. Enable **Object tagging** for scan results
6. Create or select an IAM role with S3 read/tag permissions
7. Save configuration

## Required IAM Permissions for Application

The API application needs permission to read object tags to check scan status:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObjectTagging"
      ],
      "Resource": "arn:aws:s3:::profitsentinel-dev-uploads/*"
    }
  ]
}
```

Add this to your existing API IAM role/policy.

## How It Works

1. User uploads file to S3 via presigned URL
2. GuardDuty automatically scans the new object
3. GuardDuty adds tags to the object:
   - `GuardDutyMalwareScanStatus`: `NO_THREATS_FOUND` | `THREATS_FOUND` | `UNSUPPORTED`
   - `GuardDutyScanResult`: Threat name if found (e.g., `Eicar-Test-Signature`)
4. Our API checks these tags before processing the file
5. Infected files are deleted and rejected with a 400 error

## Testing

Upload the EICAR test file to verify scanning works:

```bash
# Create EICAR test file
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.txt

# Upload to S3
aws s3 cp eicar.txt s3://profitsentinel-dev-uploads/test/eicar.txt

# Wait a few seconds, then check tags
aws s3api get-object-tagging --bucket profitsentinel-dev-uploads --key test/eicar.txt
```

Expected output should show `THREATS_FOUND` status.

## Environment Variables

Configure in your `.env` file:

```env
# Enable/disable GuardDuty scanning (default: true)
GUARDDUTY_SCAN_ENABLED=true

# Max seconds to wait for scan (default: 30)
GUARDDUTY_SCAN_TIMEOUT=30
```

## Costs

GuardDuty S3 Malware Protection pricing:
- First 500 GB scanned/month: $1.10 per GB
- 500 GB to 2,500 GB: $0.66 per GB
- Over 2,500 GB: $0.33 per GB

For typical Profit Sentinel usage (small CSV/Excel files), expect <$10/month.
