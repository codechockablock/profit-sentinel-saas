name: Deploy Production (Rust Sidecar)

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test suite (emergency deploy)'
        required: false
        default: false
        type: boolean
      confirm_production:
        description: 'Type "deploy-production" to confirm'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: profitsentinel-prod-api
  ECS_CLUSTER: profitsentinel-prod-cluster
  ECS_SERVICE: profitsentinel-prod-api-service

jobs:
  # ===========================================================================
  # GATE: Confirm production deployment
  # ===========================================================================
  confirm:
    name: Confirm Production Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Verify confirmation
        run: |
          if [ "${{ inputs.confirm_production }}" != "deploy-production" ]; then
            echo "::error::Production deployment not confirmed. Type 'deploy-production' to proceed."
            exit 1
          fi
          echo "::notice::Production deployment confirmed by ${{ github.actor }}"

  # ===========================================================================
  # SECURITY CHECK
  # ===========================================================================
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    needs: [confirm]
    steps:
      - uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          if grep -rE '(AKIA[A-Z0-9]{16}|sk-[a-zA-Z0-9]{48}|xai-[a-zA-Z0-9]{20,})' \
            --include="*.py" --include="*.rs" --include="*.toml" \
            --exclude-dir="tests" --exclude-dir="test" \
            --exclude="*test*.py" --exclude="conftest.py" \
            profit-sentinel-rs/ 2>/dev/null; then
            echo "::error::Potential secrets found in code!"
            exit 1
          fi
          echo "Security check passed"

  # ===========================================================================
  # RUST TESTS
  # ===========================================================================
  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest
    needs: [confirm]
    if: ${{ !inputs.skip_tests }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            profit-sentinel-rs/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('profit-sentinel-rs/Cargo.lock') }}

      - name: Run Rust tests
        working-directory: profit-sentinel-rs
        run: cargo test --release

  # ===========================================================================
  # PYTHON TESTS
  # ===========================================================================
  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    needs: [confirm]
    if: ${{ !inputs.skip_tests }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        working-directory: profit-sentinel-rs
        run: |
          pip install -e "python/[dev,sidecar]"

      - name: Run Python tests
        working-directory: profit-sentinel-rs
        env:
          SIDECAR_DEV_MODE: "true"
          SENTINEL_BIN: "/bin/echo"
        run: pytest python/tests/ -v --tb=short

  # ===========================================================================
  # BUILD & DEPLOY TO PRODUCTION
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [security-check, rust-tests, python-tests]
    if: |
      always() &&
      needs.security-check.result == 'success' &&
      (needs.rust-tests.result == 'success' || needs.rust-tests.result == 'skipped') &&
      (needs.python-tests.result == 'success' || needs.python-tests.result == 'skipped')
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
      previous_revision: ${{ steps.task-def.outputs.previous_revision }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          SHORT_SHA=$(echo $IMAGE_TAG | cut -c1-7)
          echo "Building production sidecar image: $SHORT_SHA"

          docker build \
            -f profit-sentinel-rs/Dockerfile.sidecar \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg GIT_COMMIT=$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$SHORT_SHA \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            profit-sentinel-rs/

          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$SHORT_SHA
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "image_tag=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Record previous task definition
        id: task-def
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          SHORT_SHA=$(echo $IMAGE_TAG | cut -c1-7)
          NEW_IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY:$SHORT_SHA"

          # Record current revision for rollback
          CURRENT_REVISION=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].taskDefinition' \
            --output text)
          echo "previous_revision=$CURRENT_REVISION" >> $GITHUB_OUTPUT
          echo "::notice::Rollback target: $CURRENT_REVISION"

          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition profitsentinel-prod-api \
            --query 'taskDefinition' \
            --output json)

          NEW_TASK_DEF=$(echo "$TASK_DEF" | jq --arg IMAGE "$NEW_IMAGE" \
            '.containerDefinitions[0].image = $IMAGE |
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          NEW_REVISION=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.revision' \
            --output text)

          echo "Registered new task definition revision: $NEW_REVISION"
          echo "revision=$NEW_REVISION" >> $GITHUB_OUTPUT

      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --task-definition profitsentinel-prod-api:${{ steps.task-def.outputs.revision }} \
            --force-new-deployment \
            --query 'service.deployments[0].status' \
            --output text

      - name: Wait for ECS deployment stability
        env:
          AWS_MAX_ATTEMPTS: 20
        run: |
          echo "Waiting for production service to stabilize..."
          aws ecs wait services-stable \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE

  # ===========================================================================
  # PRODUCTION HEALTH CHECK
  # ===========================================================================
  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: needs.deploy-production.result == 'success'
    steps:
      - name: Wait for service startup
        run: sleep 30

      - name: Check health endpoint
        run: |
          HEALTH_URL="https://api.profitsentinel.com/health"
          echo "Testing: $HEALTH_URL"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
          BODY=$(curl -s "$HEALTH_URL" || echo "{}")
          echo "Status: $HTTP_STATUS"
          echo "Body: $BODY"

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "::notice::Production health check PASSED"
          else
            echo "::error::Production health check FAILED (HTTP $HTTP_STATUS)"
            echo "::error::Rollback target: ${{ needs.deploy-production.outputs.previous_revision }}"
            exit 1
          fi

      - name: Check routes count
        run: |
          ROUTES=$(curl -s "https://api.profitsentinel.com/openapi.json" | python3 -c "import sys,json; print(len(json.load(sys.stdin)['paths']))" 2>/dev/null || echo "0")
          echo "Routes registered: $ROUTES"
          if [ "$ROUTES" -ge "40" ]; then
            echo "::notice::All routes registered ($ROUTES)"
          else
            echo "::error::Expected >= 40 routes, got $ROUTES â€” possible deployment issue"
            echo "::error::Rollback target: ${{ needs.deploy-production.outputs.previous_revision }}"
            exit 1
          fi

      - name: Check Engine 2 health
        run: |
          E2_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://api.profitsentinel.com/health/engine2" || echo "000")
          echo "Engine 2 health: HTTP $E2_STATUS"
          if [ "$E2_STATUS" != "200" ]; then
            echo "::warning::Engine 2 health endpoint returned HTTP $E2_STATUS"
          else
            echo "::notice::Engine 2 health check passed"
          fi

      - name: Smoke test
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://api.profitsentinel.com/health)
          if [ "$RESPONSE" != "200" ]; then
            echo "::error::Smoke test failed: HTTP $RESPONSE"
            exit 1
          fi
          echo "::notice::Smoke test passed (HTTP $RESPONSE)"

  # ===========================================================================
  # DEPLOYMENT SUMMARY
  # ===========================================================================
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-production, health-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "| Deploy | âœ… Success (image: \`${{ needs.deploy-production.outputs.image_tag }}\`) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Deploy | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "| Health Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Health Check | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback:** \`${{ needs.deploy-production.outputs.previous_revision }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
