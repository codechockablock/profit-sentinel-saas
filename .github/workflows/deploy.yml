name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy backend to ECS'
        required: false
        default: true
        type: boolean
      # Frontend is deployed automatically via Vercel Git integration

env:
  AWS_REGION: us-east-1

jobs:
  # ===========================================================================
  # SECURITY CHECK - Verify no secrets in code
  # ===========================================================================
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          # Check for common secret patterns (excluding test files and mock values)
          # - AKIA... = AWS Access Key ID
          # - sk-... (48 chars) = OpenAI API Key
          # - xai-... (20+ chars) = xAI API Key (exclude short test values like "xai-key")
          if grep -rE '(AKIA[A-Z0-9]{16}|sk-[a-zA-Z0-9]{48}|xai-[a-zA-Z0-9]{20,})' \
            --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" \
            --exclude-dir="tests" --exclude-dir="__tests__" --exclude-dir="test" \
            --exclude="*test*.py" --exclude="*_test.py" --exclude="*spec.ts" \
            --exclude="conftest.py" \
            . 2>/dev/null; then
            echo "::error::Potential secrets found in code!"
            exit 1
          fi
          echo "Security check passed - no secrets found"

      - name: Verify .gitignore patterns
        run: |
          for pattern in ".env" "*.tfvars" "*.tfstate" "credentials.json"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "::warning::Pattern '$pattern' not found in .gitignore"
            fi
          done
          echo "Gitignore verification complete"

  # ===========================================================================
  # RUST TESTS
  # ===========================================================================
  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            profit-sentinel-rs/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('profit-sentinel-rs/Cargo.lock') }}

      - name: Run Rust tests
        working-directory: profit-sentinel-rs
        run: cargo test --release

  # ===========================================================================
  # PYTHON TESTS
  # ===========================================================================
  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        working-directory: profit-sentinel-rs
        run: |
          pip install -e "python/[dev,sidecar]"

      - name: Run Python tests
        working-directory: profit-sentinel-rs
        env:
          SIDECAR_DEV_MODE: "true"
          SENTINEL_BIN: "/bin/echo"
        run: |
          pytest python/tests/ -v --tb=short

  # ===========================================================================
  # BACKEND DEPLOYMENT - Build once, deploy to dev + prod
  # ===========================================================================
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [security-check, rust-tests, python-tests]
    if: |
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' || github.event.inputs.deploy_backend == 'true')
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          SHORT_SHA=$(echo $IMAGE_TAG | cut -c1-7)

          echo "Building sidecar image with tag: $SHORT_SHA"
          docker build \
            -f profit-sentinel-rs/Dockerfile.sidecar \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg GIT_COMMIT=$IMAGE_TAG \
            -t $ECR_REGISTRY/profitsentinel-dev-api:$IMAGE_TAG \
            -t $ECR_REGISTRY/profitsentinel-dev-api:$SHORT_SHA \
            -t $ECR_REGISTRY/profitsentinel-dev-api:latest \
            -t $ECR_REGISTRY/profitsentinel-prod-api:$IMAGE_TAG \
            -t $ECR_REGISTRY/profitsentinel-prod-api:$SHORT_SHA \
            -t $ECR_REGISTRY/profitsentinel-prod-api:latest \
            profit-sentinel-rs/

          echo "Pushing to dev ECR..."
          docker push $ECR_REGISTRY/profitsentinel-dev-api:$IMAGE_TAG
          docker push $ECR_REGISTRY/profitsentinel-dev-api:$SHORT_SHA
          docker push $ECR_REGISTRY/profitsentinel-dev-api:latest

          echo "Pushing to prod ECR..."
          docker push $ECR_REGISTRY/profitsentinel-prod-api:$IMAGE_TAG
          docker push $ECR_REGISTRY/profitsentinel-prod-api:$SHORT_SHA
          docker push $ECR_REGISTRY/profitsentinel-prod-api:latest

          echo "image_tag=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "::notice::Docker image pushed to dev + prod ECR: $SHORT_SHA"

      # -----------------------------------------------------------------------
      # Deploy to DEV
      # -----------------------------------------------------------------------
      - name: Update dev ECS task definition
        id: dev-task-def
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          SHORT_SHA=$(echo $IMAGE_TAG | cut -c1-7)
          NEW_IMAGE="$ECR_REGISTRY/profitsentinel-dev-api:$SHORT_SHA"

          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition profitsentinel-dev-api \
            --query 'taskDefinition' \
            --output json)

          NEW_TASK_DEF=$(echo "$TASK_DEF" | jq --arg IMAGE "$NEW_IMAGE" \
            '.containerDefinitions[0].image = $IMAGE |
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          NEW_REVISION=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.revision' \
            --output text)

          echo "Dev task definition revision: $NEW_REVISION"
          echo "revision=$NEW_REVISION" >> $GITHUB_OUTPUT

      - name: Deploy to dev ECS
        run: |
          aws ecs update-service \
            --cluster profitsentinel-dev-cluster \
            --service profitsentinel-dev-api-service \
            --task-definition profitsentinel-dev-api:${{ steps.dev-task-def.outputs.revision }} \
            --force-new-deployment \
            --query 'service.deployments[0].status' \
            --output text

      - name: Wait for dev ECS stability
        run: |
          echo "Waiting for dev service to stabilize..."
          aws ecs wait services-stable \
            --cluster profitsentinel-dev-cluster \
            --services profitsentinel-dev-api-service \
            --timeout 300 || {
              echo "::warning::Dev ECS stability timed out (profitsentinel-dev-cluster/profitsentinel-dev-api-service, task-def rev ${{ steps.dev-task-def.outputs.revision }})"
              echo "::warning::Check ECS console: https://console.aws.amazon.com/ecs/v2/clusters/profitsentinel-dev-cluster/services/profitsentinel-dev-api-service"
            }

      # -----------------------------------------------------------------------
      # Deploy to PROD (api.profitsentinel.com points here)
      # -----------------------------------------------------------------------
      - name: Update prod ECS task definition
        id: prod-task-def
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          SHORT_SHA=$(echo $IMAGE_TAG | cut -c1-7)
          NEW_IMAGE="$ECR_REGISTRY/profitsentinel-prod-api:$SHORT_SHA"

          # Record current revision for rollback reference
          CURRENT_REVISION=$(aws ecs describe-services \
            --cluster profitsentinel-prod-cluster \
            --services profitsentinel-prod-api-service \
            --query 'services[0].taskDefinition' \
            --output text)
          echo "::notice::Prod rollback target: $CURRENT_REVISION"
          echo "previous_revision=$CURRENT_REVISION" >> $GITHUB_OUTPUT

          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition profitsentinel-prod-api \
            --query 'taskDefinition' \
            --output json)

          NEW_TASK_DEF=$(echo "$TASK_DEF" | jq --arg IMAGE "$NEW_IMAGE" \
            '.containerDefinitions[0].image = $IMAGE |
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          NEW_REVISION=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.revision' \
            --output text)

          echo "Prod task definition revision: $NEW_REVISION"
          echo "revision=$NEW_REVISION" >> $GITHUB_OUTPUT

      - name: Deploy to prod ECS
        run: |
          aws ecs update-service \
            --cluster profitsentinel-prod-cluster \
            --service profitsentinel-prod-api-service \
            --task-definition profitsentinel-prod-api:${{ steps.prod-task-def.outputs.revision }} \
            --force-new-deployment \
            --query 'service.deployments[0].status' \
            --output text

      - name: Wait for prod ECS stability
        run: |
          echo "Waiting for prod service to stabilize..."
          aws ecs wait services-stable \
            --cluster profitsentinel-prod-cluster \
            --services profitsentinel-prod-api-service \
            --timeout 300 || {
              echo "::warning::Prod ECS stability timed out (profitsentinel-prod-cluster/profitsentinel-prod-api-service, task-def rev ${{ steps.prod-task-def.outputs.revision }})"
              echo "::warning::Check ECS console: https://console.aws.amazon.com/ecs/v2/clusters/profitsentinel-prod-cluster/services/profitsentinel-prod-api-service"
              echo "::warning::The health check job will verify whether the deployment actually succeeded"
            }

  # ===========================================================================
  # NOTE: Frontend is deployed automatically by Vercel's Git integration.
  # No CI-based frontend deployment needed.
  # ===========================================================================

  # ===========================================================================
  # POST-DEPLOYMENT HEALTH CHECK
  # ===========================================================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    if: always() && needs.deploy-backend.result != 'skipped'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Wait for services to start
        run: sleep 30

      - name: Check dev health
        run: |
          DEV_ALB=$(aws elbv2 describe-load-balancers \
            --names profitsentinel-dev-alb \
            --query 'LoadBalancers[0].DNSName' \
            --output text 2>/dev/null || echo "")

          if [ -n "$DEV_ALB" ]; then
            STATUS=$(curl -sk -o /dev/null -w "%{http_code}" "https://$DEV_ALB/health" || echo "000")
            echo "Dev health: HTTP $STATUS"
            if [ "$STATUS" != "200" ]; then
              echo "::warning::Dev health check failed (HTTP $STATUS)"
            fi

            ROUTES=$(curl -sk "https://$DEV_ALB/openapi.json" | python3 -c "import sys,json; print(len(json.load(sys.stdin)['paths']))" 2>/dev/null || echo "0")
            echo "Dev routes: $ROUTES"
            if [ "$ROUTES" -lt "40" ]; then
              echo "::warning::Dev has only $ROUTES routes (expected >= 40)"
            fi
          else
            echo "::warning::Could not find dev ALB"
          fi

      - name: Check prod health
        run: |
          HEALTH_URL="https://api.profitsentinel.com/health"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
          BODY=$(curl -s "$HEALTH_URL" || echo "{}")
          echo "Prod health: HTTP $STATUS"
          echo "Prod body: $BODY"

          if [ "$STATUS" != "200" ]; then
            echo "::error::Prod health check FAILED (HTTP $STATUS)"
            echo "::error::Rollback target: ${{ needs.deploy-backend.outputs.prod_previous_revision }}"
            exit 1
          fi

      - name: Check prod route count
        run: |
          ROUTES=$(curl -s "https://api.profitsentinel.com/openapi.json" | python3 -c "import sys,json; print(len(json.load(sys.stdin)['paths']))" 2>/dev/null || echo "0")
          echo "Prod routes: $ROUTES"
          if [ "$ROUTES" -lt "40" ]; then
            echo "::error::Prod has only $ROUTES routes (expected >= 40) — possible deployment issue"
            exit 1
          fi
          echo "::notice::Prod routes OK ($ROUTES)"

      - name: Check Engine 2 health
        run: |
          E2_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://api.profitsentinel.com/health/engine2" || echo "000")
          echo "Engine 2 health: HTTP $E2_STATUS"
          if [ "$E2_STATUS" != "200" ]; then
            echo "::warning::Engine 2 health endpoint returned HTTP $E2_STATUS"
          else
            E2_BODY=$(curl -s "https://api.profitsentinel.com/health/engine2")
            echo "Engine 2 status: $E2_BODY"
            echo "::notice::Engine 2 health check passed"
          fi

  # ===========================================================================
  # DEPLOYMENT SUMMARY
  # ===========================================================================
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, health-check]
    if: always()
    steps:
      - name: Generate deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-backend.result }}" == "success" ]; then
            echo "| Backend (dev + prod) | :white_check_mark: Success | Image: \`${{ needs.deploy-backend.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-backend.result }}" == "skipped" ]; then
            echo "| Backend | :fast_forward: Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backend | :x: Failed | Check logs |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "| Health Check | :white_check_mark: Passed | |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.health-check.result }}" == "skipped" ]; then
            echo "| Health Check | :fast_forward: Skipped | |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Health Check | :x: Failed | |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| Frontend | :fast_forward: Via Vercel Git integration | - |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Git Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow run:** [View details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Report final status
        run: |
          if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "::notice::Deployment successful (dev + prod)!"
          elif [ "${{ needs.deploy-backend.result }}" == "skipped" ]; then
            echo "::notice::No deployments were triggered"
          else
            echo "::error::Deployment issue — check health check results"
          fi
