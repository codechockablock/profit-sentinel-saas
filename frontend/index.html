<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Sentinel - Uncover Hidden Profit Leaks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/heroicons@2.1.1/outline.js"></script> <!-- For icons -->

    <style>
        @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #065f46, #10b981); }
        .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card-hover:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .file-progress { margin-top: 0.5rem; }
        .progress-bg { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: #10b981; width: 0%; transition: width 0.3s ease; }
        .animate-fade-in { animation: fadeIn 0.8s ease-out; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ë</text></svg>">
</head>
<body class="bg-gray-50 text-gray-800">

    <section id="upload" class="py-24 bg-white">
        <div class="container mx-auto px-6 text-center max-w-4xl">
            <h2 class="text-5xl font-bold mb-8 text-gray-800">Get Your Free Profit Leak Report</h2>
            <p class="text-xl mb-12 text-gray-600">Upload one or more POS exports (CSV or Excel) ‚Äî instant forensic analysis. No signup required for beta.</p>
            
            <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-12 rounded-3xl shadow-2xl">

                <form id="uploadForm" class="space-y-8">
                    <div>
                        <label for="file" class="block text-left text-2xl font-semibold mb-4 text-gray-800">Upload POS Exports (multiple allowed)</label>
                        <input type="file" id="file" name="file" accept=".csv,.xlsx,.xls" multiple class="w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-200 transition">
                    </div>
                    <div>
                        <label for="email" class="block text-left text-2xl font-semibold mb-4 text-gray-800">Email (to send your report)</label>
                        <input type="email" id="email" name="email" class="w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-200 transition" placeholder="you@store.com">
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 text-white font-bold text-2xl py-6 rounded-2xl hover:from-emerald-700 hover:to-emerald-800 transition transform hover:scale-105 shadow-2xl">
                        Analyze My Profits ‚Äì Free Beta
                    </button>
                </form>
                
                <div id="status" class="mt-10 text-2xl font-medium text-emerald-600"></div>
                <div id="uploadProgress" class="mt-8 space-y-4"></div>
                <div id="result" class="mt-12 hidden"></div>
            </div>
        </div>
    </section>

    <!-- Initialize Supabase Client -->
    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://kbjiejqotrjsdeuxhtcx.supabase.co',
            'sb_publishable_gocACZSOQvdZ6XV1qiu28A_W19nqgYc'
        );
    </script>

    <!-- Upload & Analysis Script with Pretty Results -->
<!-- Upload & Analysis Script with Pretty Results -->
<script>
    const form = document.getElementById('uploadForm');
    const status = document.getElementById('status');
    const uploadProgress = document.getElementById('uploadProgress');
    const result = document.getElementById('result');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const files = document.getElementById('file').files;
        
        if (files.length === 0) {
            status.textContent = 'Please select at least one file.';
            return;
        }

        status.textContent = 'Generating secure upload links...';
        uploadProgress.innerHTML = '';
        result.classList.add('hidden');

        const formData = new FormData();
        for (let file of files) {
            formData.append('filenames', file.name);
        }
        const emailValue = document.getElementById('email').value.trim();
        if (emailValue) formData.append('email', emailValue);

        let headers = {};
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                headers['Authorization'] = `Bearer ${session.access_token}`;
            }
        } catch (err) {
            console.warn('No auth session (normal for beta)', err);
        }

        try {
            // === 1. Get presigned URLs ===
            const presignRes = await fetch('https://profitsentinel-dev-alb-1068333431.us-east-1.elb.amazonaws.com/presign', {
                method: 'POST',
                headers: headers,
                body: formData
            });

            if (!presignRes.ok) {
                const errorText = await presignRes.text();
                throw new Error(`Failed to get upload links: ${presignRes.status} ${errorText}`);
            }

            const { presigned } = await presignRes.json();

            // === 2. Upload files with progress bars ===
            status.textContent = `Uploading ${files.length} file${files.length > 1 ? 's' : ''}...`;

            uploadProgress.innerHTML = '';
            const progressBars = [];
            presigned.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'file-progress';
                div.innerHTML = `
                    <p class="text-sm text-gray-600 mb-1">${files[i].name} (${(files[i].size / 1024 / 1024).toFixed(1)} MB)</p>
                    <div class="progress-bg">
                        <div class="progress-bar" id="bar-${i}"></div>
                    </div>
                `;
                uploadProgress.appendChild(div);
                progressBars.push(document.getElementById(`bar-${i}`));
            });

            const uploadPromises = presigned.map(async (p, i) => {
                const file = files[i];
                const xhr = new XMLHttpRequest();

                return new Promise((resolve, reject) => {
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percent = (e.loaded / e.total) * 100;
                            progressBars[i].style.width = percent + '%';
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve(p.key);
                        } else {
                            reject(new Error(`Upload failed: ${xhr.status}`));
                        }
                    });
                    xhr.addEventListener('error', reject);
                    xhr.addEventListener('abort', reject);

                    xhr.open('POST', p.url.url);
                    const uploadForm = new FormData();
                    Object.keys(p.url.fields).forEach(key => uploadForm.append(key, p.url.fields[key]));
                    uploadForm.append('file', file);
                    xhr.send(uploadForm);
                });
            });

            const keys = await Promise.all(uploadPromises);

            // === 3. Trigger analysis ===
            status.textContent = 'Analyzing your files...';

            const analyzeForm = new FormData();
            keys.forEach(key => analyzeForm.append('keys', key));
            if (emailValue) analyzeForm.append('email', emailValue);

            const analyzeRes = await fetch('https://profitsentinel-dev-alb-1068333431.us-east-1.elb.amazonaws.com/analyze', {
                method: 'POST',
                headers: headers,
                body: analyzeForm
            });

            if (!analyzeRes.ok) {
                const errorText = await analyzeRes.text();
                throw new Error(`Analysis failed: ${analyzeRes.status} ${errorText}`);
            }

            const data = await analyzeRes.json();

            // === 4. Render Beautiful Results ===
            uploadProgress.innerHTML = '';
            status.innerHTML = '<span class="text-emerald-600 font-bold text-3xl">Analysis complete! üöÄ</span>';

            let totalHidden = 0;
            let totalNegative = 0;
            let maxImpact = 0;
            let successCount = 0;

            data.results.forEach(r => {
                if (r.status === "success") {
                    successCount++;
                    totalHidden += r.estimated_hidden_cogs || 0;
                    totalNegative += r.negative_items || 0;
                    if (r.margin_impact_pct > maxImpact) maxImpact = r.margin_impact_pct;
                }
            });

            result.innerHTML = `
                <div class="mt-12 animate-fade-in">
                    <!-- Hero Summary -->
                    <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white p-10 rounded-3xl shadow-2xl mb-12 text-center">
                        <h3 class="text-4xl font-bold mb-6">Your Profit Leak Report</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                            <div>
                                <p class="text-emerald-100 text-lg">Files Processed</p>
                                <p class="text-5xl font-black mt-2">${data.results.length}</p>
                            </div>
                            <div>
                                <p class="text-emerald-100 text-lg">Hidden COGS</p>
                                <p class="text-5xl font-black mt-2 $${totalHidden > 0 ? 'text-yellow-300' : ''}">$${totalHidden.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</p>
                            </div>
                            <div>
                                <p class="text-emerald-100 text-lg">Negative Items</p>
                                <p class="text-5xl font-black mt-2 ${totalNegative > 0 ? 'text-red-300' : ''}">${totalNegative}</p>
                            </div>
                            <div>
                                <p class="text-emerald-100 text-lg">Max Margin Impact</p>
                                <p class="text-5xl font-black mt-2 ${maxImpact > 5 ? 'text-orange-300' : ''}">${maxImpact.toFixed(1)}%</p>
                            </div>
                        </div>
                        <p class="mt-10 text-2xl font-medium">
                            ${totalHidden > 0 || totalNegative > 0 
                                ? 'üî¥ We found potential profit leaks ‚Äì see details below!' 
                                : 'üü¢ Your inventory looks clean ‚Äì great processes!'}
                        </p>
                    </div>

                    <!-- Individual File Cards -->
                    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                        ${data.results.map(file => `
                            <div class="bg-white border-2 ${file.status !== 'success' ? 'border-red-500' : 'border-gray-200'} rounded-3xl shadow-xl p-8 card-hover">
                                <h4 class="font-bold text-xl mb-3 truncate text-gray-800">${file.filename || 'Unknown file'}</h4>
                                <p class="text-sm text-gray-500 mb-6">${file.rows?.toLocaleString() || 'N/A'} rows analyzed</p>

                                ${file.status === 'success' ? `
                                    <div class="space-y-6">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Negative Items Found</span>
                                            <span class="text-3xl font-bold ${file.negative_items > 0 ? 'text-red-600' : 'text-green-600'}">${file.negative_items}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Estimated Hidden COGS</span>
                                            <span class="text-3xl font-bold text-emerald-600">$${file.estimated_hidden_cogs.toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">True Margin</span>
                                            <span class="text-2xl font-bold">${file.true_margin_pct.toFixed(1)}%</span>
                                        </div>
                                        <div class="pt-6 border-t border-gray-200">
                                            <p class="text-sm italic text-gray-700 leading-relaxed">${file.summary}</p>
                                            <p class="text-sm text-gray-600 mt-3">${file.recommendation}</p>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="text-red-600 font-bold text-lg">
                                        ‚ö†Ô∏è Partial Analysis<br>
                                        <span class="text-base font-normal">${file.detail}</span>
                                    </div>
                                `}
                            </div>
                        `).join('')}
                    </div>

                    <div class="text-center mt-12">
                        <p class="text-gray-600">Detailed report sent to <span class="font-semibold">${emailValue || 'your email'}</span></p>
                    </div>
                </div>
            `;

            result.classList.remove('hidden');

        } catch (err) {
            console.error(err);
            status.textContent = 'Error: ' + (err.message || 'Something went wrong ‚Äì check network or try again.');
            status.className = 'mt-10 text-2xl font-medium text-red-600';
        }
    });
</script></body>
</html>