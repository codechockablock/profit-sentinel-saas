<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Sentinel - Uncover Hidden Profit Leaks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #0f172a, #1e293b);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .hero-bg {
            background-image: url('https://images.unsplash.com/photo-1635070041078-e363dbe005cb?ixlib=rb-4.0.3&auto=format&fit=crop&q=80');
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .hero-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(15,23,42,0.8));
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .result-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(16, 185, 129, 0.4);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .result-card:hover {
            transform: translateY(-20px) scale(1.05);
            box-shadow: 0 50px 100px rgba(16, 185, 129, 0.25);
            border-color: rgba(16, 185, 129, 0.8);
        }

        .glow {
            box-shadow: 0 0 60px rgba(16, 185, 129, 0.4);
        }

        .logo-glow {
            filter: drop-shadow(0 0 50px rgba(16, 185, 129, 0.9));
        }

        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 40px rgba(16, 185, 129, 0.6)); }
            50% { filter: drop-shadow(0 0 80px rgba(16, 185, 129, 1)); }
        }

        .animate-pulse-glow {
            animation: pulse-glow 6s infinite ease-in-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(80px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in-up {
            animation: fadeInUp 1.2s ease-out forwards;
        }
    </style>
</head>
<body>

    <!-- Hero Section -->
    <header class="hero-bg relative text-white py-40 md:py-60">
        <div class="container mx-auto px-6 text-center relative z-10">
            <div class="mb-12">
                <img 
                    src="https://i.imgur.com/68NbW7U.png"
                    alt="Profit Sentinel Logo"
                    class="mx-auto max-w-full h-64 md:h-96 lg:h-[28rem] logo-glow animate-pulse-glow object-contain"
                />
                <p class="text-2xl md:text-3xl opacity-80 mt-8">AI-Powered Profit Forensics</p>
            </div>

            <p class="text-3xl md:text-5xl opacity-90 max-w-5xl mx-auto mb-8">Uncover Hidden Profit Leaks</p>
            <p class="text-xl md:text-2xl opacity-80 max-w-4xl mx-auto">Instant AI-powered forensic analysis of your POS exports. Free beta — no signup required.</p>
        </div>
    </header>

    <!-- Upload CTA Section -->
    <section class="py-32 relative -mt-32">
        <div class="container mx-auto px-6 max-w-6xl">
            <div class="glass-card p-20 rounded-3xl glow">
                <div class="text-center mb-16">
                    <h2 class="text-5xl font-bold mb-6">Get Your Free Report</h2>
                    <p class="text-2xl opacity-80">Upload POS exports below for immediate analysis</p>
                </div>

                <form id="uploadForm" class="space-y-16">
                    <div>
                        <label class="block text-2xl font-semibold mb-6">POS Export File (CSV/Excel)</label>
                        <input type="file" id="file" name="file" accept=".csv,.xlsx,.xls" class="w-full px-10 py-10 text-2xl bg-white/5 border-2 border-emerald-500/40 rounded-3xl focus:border-emerald-400 focus:ring-8 focus:ring-emerald-400/20 transition">
                    </div>

                    <div>
                        <label class="block text-2xl font-semibold mb-6">Email (for detailed report)</label>
                        <input type="email" id="email" name="email" placeholder="optional@yourstore.com" class="w-full px-10 py-8 text-2xl bg-white/5 border-2 border-gray-500/40 rounded-3xl focus:border-emerald-400 focus:ring-8 focus:ring-emerald-400/20 transition">
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-black text-4xl py-10 rounded-3xl hover:from-emerald-600 hover:to-emerald-700 transition transform hover:scale-105 glow">
                        Analyze Profits Now
                    </button>
                </form>

                <div id="status" class="mt-20 text-4xl font-bold text-center"></div>
                <div id="uploadProgress" class="mt-16"></div>
                <div id="mappingSection" class="mt-32 hidden"></div>
                <div id="result" class="mt-32 hidden"></div>
            </div>
        </div>
    </section>

    <!-- Supabase Init -->
    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://kbjiejqotrjsdeuxhtcx.supabase.co',
            'sb_publishable_gocACZSOQvdZ6XV1qiu28A_W19nqgYc'
        );

        const BACKEND_URL = 'https://profitsentinel-dev-alb-1068333431.us-east-1.elb.amazonaws.com';  // Your production backend

        const form = document.getElementById('uploadForm');
        const status = document.getElementById('status');
        const uploadProgress = document.getElementById('uploadProgress');
        const mappingSection = document.getElementById('mappingSection');
        const result = document.getElementById('result');

        let currentKey = null;
        let currentMapping = {};

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            if (!file) {
                status.textContent = 'Please select a file';
                status.className = 'text-red-400';
                return;
            }

            status.textContent = 'Generating upload link...';
            status.className = 'text-emerald-400';
            uploadProgress.innerHTML = '';
            mappingSection.classList.add('hidden');
            result.classList.add('hidden');

            const formData = new FormData();
            formData.append('filenames', file.name);

            let headers = {};
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) headers['Authorization'] = `Bearer ${session.access_token}`;
            } catch (err) {}

            try {
                const presignRes = await fetch(`${BACKEND_URL}/presign`, {
                    method: 'POST',
                    headers,
                    body: formData
                });
                if (!presignRes.ok) throw new Error(await presignRes.text());
                const { presigned_urls } = await presignRes.json();
                const p = presigned_urls[0];
                currentKey = p.key;

                status.textContent = 'Uploading file...';
                const progressBar = document.createElement('div');
                progressBar.innerHTML = `
                    <p class="text-xl font-medium mb-4">${file.name} <span class="text-gray-400">(${(file.size / 1024 / 1024).toFixed(1)} MB)</span></p>
                    <div class="h-4 bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-600 transition-all duration-500 w-0" id="progressBar"></div>
                    </div>
                `;
                uploadProgress.appendChild(progressBar);
                const bar = document.getElementById('progressBar');

                const xhr = new XMLHttpRequest();
                xhr.upload.addEventListener('progress', e => {
                    if (e.lengthComputable) bar.style.width = (e.loaded / e.total) * 100 + '%';
                });
                await new Promise((resolve, reject) => {
                    xhr.addEventListener('load', () => xhr.status >= 200 && xhr.status < 300 ? resolve() : reject());
                    xhr.addEventListener('error', reject);
                    xhr.open('PUT', p.url);
                    xhr.setRequestHeader('Content-Type', 'application/octet-stream');
                    xhr.send(file);
                });

                status.textContent = 'Suggesting column mapping...';
                const mappingForm = new FormData();
                mappingForm.append('key', currentKey);
                mappingForm.append('filename', file.name);

                const mappingRes = await fetch(`${BACKEND_URL}/suggest-mapping`, {
                    method: 'POST',
                    headers,
                    body: mappingForm
                });
                if (!mappingRes.ok) throw new Error(await mappingRes.text());
                const mappingData = await mappingRes.json();

                // Show mapping for confirmation
                mappingSection.innerHTML = `
                    <div class="glass-card p-16 rounded-3xl">
                        <h3 class="text-4xl font-bold mb-12 text-center">Confirm Column Mapping</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                            ${Object.entries(mappingData.suggestions || {}).map(([col, mapped]) => `
                                <div class="bg-white/5 rounded-2xl p-8">
                                    <p class="text-xl opacity-80">Column: <span class="font-bold text-emerald-400">${col}</span></p>
                                    <p class="text-2xl mt-4">→ <span class="font-bold ${mapped ? 'text-emerald-400' : 'text-red-400'}">${mapped || 'Unmapped'}</span></p>
                                </div>
                            `).join('')}
                        </div>
                        <button id="confirmMapping" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-black text-3xl py-8 rounded-3xl hover:from-emerald-600 hover:to-emerald-700 transition transform hover:scale-105 glow">
                            Confirm & Run Full Analysis
                        </button>
                    </div>
                `;
                mappingSection.classList.remove('hidden');

                currentMapping = mappingData.suggestions || {};

                document.getElementById('confirmMapping').addEventListener('click', async () => {
                    status.textContent = 'Running full resonator analysis...';
                    mappingSection.classList.add('hidden');

                    const analyzeForm = new FormData();
                    analyzeForm.append('key', currentKey);
                    analyzeForm.append('mapping', JSON.stringify(currentMapping));

                    const analyzeRes = await fetch(`${BACKEND_URL}/analyze`, {
                        method: 'POST',
                        headers,
                        body: analyzeForm
                    });
                    if (!analyzeRes.ok) throw new Error(await analyzeRes.text());
                    const analyzeData = await analyzeRes.json();

                    status.textContent = 'Analysis Complete!';
                    status.className = 'text-emerald-400';

                    // Display resonator leaks
                    result.innerHTML = `
                        <div class="glass-card p-20 rounded-3xl glow">
                            <h2 class="text-6xl font-black mb-16 text-center">Resonator Profit Leak Analysis</h2>
                            <div class="grid gap-16 md:grid-cols-2">
                                ${Object.entries(analyzeData.leaks || {}).map(([primitive, data]) => `
                                    <div class="bg-white/5 rounded-3xl p-12">
                                        <h3 class="text-4xl font-bold mb-8 capitalize">${primitive.replace('_', ' ')}</h3>
                                        <ol class="space-y-6 text-xl">
                                            ${data.top_items.slice(0, 10).map((item, i) => `
                                                <li class="flex justify-between">
                                                    <span>${item || 'Unknown'}</span>
                                                    <span class="text-emerald-400 font-bold">${data.scores[i]?.toFixed(2) || 'N/A'}</span>
                                                </li>
                                            `).join('')}
                                        </ol>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    result.classList.remove('hidden');
                });

            } catch (err) {
                console.error(err);
                status.textContent = 'Error: ' + (err.message || 'Failed');
                status.className = 'text-red-400';
            }
        });
    </script>
</body>
</html>