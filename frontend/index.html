<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Sentinel - Uncover Hidden Profit Leaks</title>
    <link rel="icon" href="https://i.imgur.com/68NbW7U.png" type="image/png">
    <!-- Supabase JS client (optional - for authenticated features) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* =================================================================
           Tailwind CSS Utility Classes (Production Build)
           Generated from required utilities - replaces CDN script
           ================================================================= */
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
        html { line-height: 1.5; -webkit-text-size-adjust: 100%; font-family: 'Inter', ui-sans-serif, system-ui, sans-serif; }
        body { margin: 0; line-height: inherit; }
        h2, h3, h4, p { margin: 0; }
        button, input { font-family: inherit; font-size: 100%; font-weight: inherit; line-height: inherit; color: inherit; margin: 0; padding: 0; }
        button { text-transform: none; cursor: pointer; background-color: transparent; background-image: none; }
        img { display: block; max-width: 100%; height: auto; }

        /* Utility classes */
        .container { width: 100%; margin-left: auto; margin-right: auto; padding-left: 1rem; padding-right: 1rem; }
        @media (min-width: 640px) { .container { max-width: 640px; } }
        @media (min-width: 768px) { .container { max-width: 768px; } }
        @media (min-width: 1024px) { .container { max-width: 1024px; } }
        @media (min-width: 1280px) { .container { max-width: 1280px; } }

        .relative { position: relative; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mb-12 { margin-bottom: 3rem; }
        .mb-16 { margin-bottom: 4rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-8 { margin-top: 2rem; }
        .mt-16 { margin-top: 4rem; }
        .mt-20 { margin-top: 5rem; }
        .mt-32 { margin-top: 8rem; }
        .-mt-32 { margin-top: -8rem; }
        .block { display: block; }
        .flex { display: flex; }
        .grid { display: grid; }
        .hidden { display: none; }
        .h-6 { height: 1.5rem; }
        .h-full { height: 100%; }
        .h-64 { height: 16rem; }
        .max-w-full { max-width: 100%; }
        .max-w-4xl { max-width: 56rem; }
        .max-w-5xl { max-width: 64rem; }
        .max-w-6xl { max-width: 72rem; }
        .w-full { width: 100%; }
        .w-0 { width: 0; }
        .object-contain { object-fit: contain; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .justify-between { justify-content: space-between; }
        .gap-6 { gap: 1.5rem; }
        .gap-12 { gap: 3rem; }
        .space-y-3 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.75rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }
        .space-y-10 > :not([hidden]) ~ :not([hidden]) { margin-top: 2.5rem; }
        .space-y-12 > :not([hidden]) ~ :not([hidden]) { margin-top: 3rem; }
        .space-y-16 > :not([hidden]) ~ :not([hidden]) { margin-top: 4rem; }
        .space-y-20 > :not([hidden]) ~ :not([hidden]) { margin-top: 5rem; }
        .overflow-hidden { overflow: hidden; }
        .scroll-smooth { scroll-behavior: smooth; }
        .rounded-full { border-radius: 9999px; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-3xl { border-radius: 1.5rem; }
        .border-2 { border-width: 2px; }
        .bg-white\/5 { background-color: rgb(255 255 255 / 0.05); }
        .bg-gray-700 { background-color: #374151; }
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
        .from-emerald-500 { --tw-gradient-from: #10b981; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgb(16 185 129 / 0)); }
        .to-emerald-600 { --tw-gradient-to: #059669; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .px-10 { padding-left: 2.5rem; padding-right: 2.5rem; }
        .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .py-10 { padding-top: 2.5rem; padding-bottom: 2.5rem; }
        .py-32 { padding-top: 8rem; padding-bottom: 8rem; }
        .py-40 { padding-top: 10rem; padding-bottom: 10rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .p-12 { padding: 3rem; }
        .p-16 { padding: 4rem; }
        .p-20 { padding: 5rem; }
        .text-center { text-align: center; }
        .font-sans { font-family: 'Inter', ui-sans-serif, system-ui, sans-serif; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        .text-5xl { font-size: 3rem; line-height: 1; }
        .text-6xl { font-size: 3.75rem; line-height: 1; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .font-black { font-weight: 900; }
        .capitalize { text-transform: capitalize; }
        .text-white { color: #fff; }
        .text-gray-400 { color: #9ca3af; }
        .text-emerald-400 { color: #34d399; }
        .text-red-400 { color: #f87171; }
        .opacity-80 { opacity: 0.8; }
        .opacity-90 { opacity: 0.9; }
        .transition { transition-property: color, background-color, border-color, fill, stroke, opacity, box-shadow, transform; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .duration-300 { transition-duration: 300ms; }
        .z-10 { z-index: 10; }

        /* Focus states */
        .focus\:border-emerald-400:focus { border-color: #34d399; }
        .focus\:ring-8:focus { --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(8px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); }
        .focus\:ring-emerald-400\/20:focus { --tw-ring-color: rgb(52 211 153 / 0.2); }

        /* Hover states */
        .hover\:from-emerald-600:hover { --tw-gradient-from: #059669; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgb(5 150 105 / 0)); }
        .hover\:to-emerald-700:hover { --tw-gradient-to: #047857; }
        .hover\:scale-105:hover { transform: scale(1.05); }

        /* Responsive variants */
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:py-60 { padding-top: 15rem; padding-bottom: 15rem; }
            .md\:h-96 { height: 24rem; }
            .md\:text-2xl { font-size: 1.5rem; line-height: 2rem; }
            .md\:text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
            .md\:text-5xl { font-size: 3rem; line-height: 1; }
        }
        @media (min-width: 1024px) {
            .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .lg\:h-\[28rem\] { height: 28rem; }
        }

        /* Border colors */
        .border-emerald-500\/40 { border-color: rgb(16 185 129 / 0.4); }
        .border-gray-500\/40 { border-color: rgb(107 114 128 / 0.4); }

        /* =================================================================
           Custom Styles
           ================================================================= */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #0f172a, #1e293b);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .hero-bg {
            background-image: url('https://images.unsplash.com/photo-1635070041078-e363dbe005cb?ixlib=rb-4.0.3&auto=format&fit=crop&q=80');
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .hero-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(15,23,42,0.8));
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .result-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(16, 185, 129, 0.4);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .result-card:hover {
            transform: translateY(-20px) scale(1.05);
            box-shadow: 0 50px 100px rgba(16, 185, 129, 0.25);
            border-color: rgba(16, 185, 129, 0.8);
        }

        .glow {
            box-shadow: 0 0 60px rgba(16, 185, 129, 0.4);
        }

        .logo-glow {
            filter: drop-shadow(0 0 50px rgba(16, 185, 129, 0.9));
        }

        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 40px rgba(16, 185, 129, 0.6)); }
            50% { filter: drop-shadow(0 0 80px rgba(16, 185, 129, 1)); }
        }

        .animate-pulse-glow {
            animation: pulse-glow 6s infinite ease-in-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(80px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in-up {
            animation: fadeInUp 1.2s ease-out forwards;
        }
    </style>
</head>
<body>

    <!-- Hero Section -->
    <header class="hero-bg relative text-white py-40 md:py-60">
        <div class="container mx-auto px-6 text-center relative z-10">
            <div class="mb-12">
                <img 
                    src="https://i.imgur.com/68NbW7U.png"
                    alt="Profit Sentinel Logo"
                    class="mx-auto max-w-full h-64 md:h-96 lg:h-[28rem] logo-glow animate-pulse-glow object-contain"
                />
                <p class="text-2xl md:text-3xl opacity-80 mt-8">AI-Powered Profit Forensics</p>
            </div>

            <p class="text-3xl md:text-5xl opacity-90 max-w-5xl mx-auto mb-8">Uncover Hidden Profit Leaks</p>
            <p class="text-xl md:text-2xl opacity-80 max-w-4xl mx-auto">Instant AI-powered forensic analysis of your POS exports. Free beta — no signup required.</p>
        </div>
    </header>

    <!-- Upload CTA Section -->
    <section class="py-32 relative -mt-32">
        <div class="container mx-auto px-6 max-w-6xl">
            <div class="glass-card p-20 rounded-3xl glow">
                <div class="text-center mb-16">
                    <h2 class="text-5xl font-bold mb-6">Get Your Free Report</h2>
                    <p class="text-2xl opacity-80">Upload POS exports below for immediate analysis</p>
                </div>

                <form id="uploadForm" class="space-y-16">
                    <div>
                        <label class="block text-2xl font-semibold mb-6">POS Export Files</label>
                        <input type="file" id="file" name="file" accept=".csv,.xlsx,.xls" multiple class="w-full px-10 py-10 text-2xl bg-white/5 border-2 border-emerald-500/40 rounded-3xl focus:border-emerald-400 focus:ring-8 focus:ring-emerald-400/20 transition">
                    </div>

                    <div>
                        <label class="block text-2xl font-semibold mb-6">Email (for detailed report)</label>
                        <input type="email" id="email" name="email" placeholder="optional@yourstore.com" class="w-full px-10 py-8 text-2xl bg-white/5 border-2 border-gray-500/40 rounded-3xl focus:border-emerald-400 focus:ring-8 focus:ring-emerald-400/20 transition">
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-black text-4xl py-10 rounded-3xl hover:from-emerald-600 hover:to-emerald-700 transition transform hover:scale-105 glow">
                        Analyze Profits Now
                    </button>
                </form>

                <div id="status" class="mt-20 text-4xl font-bold text-center"></div>
                <div id="uploadProgress" class="mt-16 space-y-10"></div>
                <div id="mappingSection" class="mt-32 hidden"></div>
                <div id="result" class="mt-32 hidden"></div>
            </div>
        </div>
    </section>

    <!-- Application Configuration -->
    <script>
        // =====================================================================
        // CONFIGURATION
        // =====================================================================
        // Backend API URL - publicly accessible, not a secret
        const BACKEND_URL = 'https://api.profitsentinel.com';

        // Supabase configuration (optional - for authenticated features)
        // These are PUBLIC keys, safe for client-side use
        // For static deployment: set values directly below
        // For dynamic config: use env-config.js (see env-config.js.template)
        const SUPABASE_URL = window.ENV_SUPABASE_URL || '';
        const SUPABASE_ANON_KEY = window.ENV_SUPABASE_ANON_KEY || '';

        // Initialize Supabase client only if configured
        let supabaseClient = null;
        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
            try {
                const { createClient } = supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (err) {
                console.warn('[Profit Sentinel] Failed to initialize Supabase:', err.message);
            }
        }

        // Log configuration status only in development (check for localhost)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('[Profit Sentinel] Backend URL:', BACKEND_URL);
            console.log('[Profit Sentinel] Supabase configured:', !!supabaseClient);
        }

        const form = document.getElementById('uploadForm');
        const status = document.getElementById('status');
        const uploadProgress = document.getElementById('uploadProgress');
        const mappingSection = document.getElementById('mappingSection');
        const result = document.getElementById('result');

        let fileData = [];

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const files = document.getElementById('file').files;
            if (files.length === 0) {
                status.textContent = 'Please select files';
                status.className = 'text-red-400';
                return;
            }

            status.textContent = 'Generating upload links...';
            status.className = 'text-emerald-400';
            uploadProgress.innerHTML = '';
            mappingSection.classList.add('hidden');
            result.classList.add('hidden');
            fileData = [];

            const formData = new FormData();
            for (let file of files) formData.append('filenames', file.name);

            let headers = {};
            if (supabaseClient) {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) headers['Authorization'] = `Bearer ${session.access_token}`;
                } catch (err) {
                    // Silently fail - auth is optional
                }
            }

            try {
                const presignRes = await fetch(`${BACKEND_URL}/uploads/presign`, {
                    method: 'POST',
                    headers,
                    body: formData
                });
                if (!presignRes.ok) throw new Error(await presignRes.text());
                const data = await presignRes.json();
                console.log('Presigned response:', data);

                const presigned = data.presigned_urls || [];
                if (presigned.length === 0 || presigned.length !== files.length) {
                    throw new Error('No presigned URLs returned or count mismatch');
                }

                status.textContent = `Uploading ${files.length} file${files.length > 1 ? 's' : ''}...`;
                status.className = 'text-emerald-400';

                uploadProgress.innerHTML = '';
                const progressBars = [];

                presigned.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = 'space-y-4';
                    div.innerHTML = `
                        <p class="text-xl font-medium">${files[i].name} 
                            <span class="text-gray-400">(${(files[i].size / 1024 / 1024).toFixed(1)} MB)</span>
                        </p>
                        <div class="w-full bg-gray-700 rounded-full h-6 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-600 transition-all duration-300 w-0" 
                                 id="bar-${i}"></div>
                        </div>
                        <p class="text-sm text-gray-400" id="percent-${i}">0%</p>
                    `;
                    uploadProgress.appendChild(div);
                    progressBars.push({
                        bar: document.getElementById(`bar-${i}`),
                        percent: document.getElementById(`percent-${i}`)
                    });
                });

                const uploadPromises = presigned.map(async (p, i) => {
                    const file = files[i];

                    return new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();

                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);
                                progressBars[i].bar.style.width = percent + '%';
                                progressBars[i].percent.textContent = percent + '%';
                            }
                        });

                        xhr.addEventListener('load', () => {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                resolve({ key: p.key, filename: file.name });
                            } else {
                                reject(new Error(`Upload failed: ${xhr.status} ${xhr.responseText || xhr.statusText}`));
                            }
                        });

                        xhr.addEventListener('error', () => reject(new Error('Network error during upload')));
                        xhr.addEventListener('abort', () => reject(new Error('Upload aborted')));

                        xhr.open('PUT', p.url);
                        xhr.setRequestHeader('Content-Type', 'application/octet-stream');
                        xhr.send(file);
                    });
                });

                const uploadedFiles = await Promise.all(uploadPromises);

                status.textContent = 'Suggesting column mappings...';

                const mappingPromises = uploadedFiles.map(async (f) => {
                    const mappingForm = new FormData();
                    mappingForm.append('key', f.key);
                    mappingForm.append('filename', f.filename);

                    const mappingRes = await fetch(`${BACKEND_URL}/uploads/suggest-mapping`, {
                        method: 'POST',
                        headers,
                        body: mappingForm
                    });
                    if (!mappingRes.ok) throw new Error(await mappingRes.text());
                    const mappingData = await mappingRes.json();
                    return { key: f.key, filename: f.filename, mapping: mappingData.suggestions || {}, confidences: mappingData.confidences || {} };
                });

                fileData = await Promise.all(mappingPromises);

                mappingSection.innerHTML = `
                    <div class="glass-card p-16 rounded-3xl">
                        <h3 class="text-4xl font-bold mb-12 text-center">Confirm Column Mappings (${fileData.length} files)</h3>
                        <div class="space-y-12 mb-12">
                            ${fileData.map((f) => `
                                <div class="bg-white/5 rounded-2xl p-8">
                                    <h4 class="text-2xl font-bold mb-6">${f.filename}</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        ${Object.entries(f.mapping).map(([col, mapped]) => `
                                            <div class="bg-white/5 rounded-xl p-6">
                                                <p class="text-lg opacity-80">Column: <span class="font-bold text-emerald-400">${col}</span></p>
                                                <p class="text-xl mt-2">→ <span class="font-bold ${mapped ? 'text-emerald-400' : 'text-red-400'}">${mapped || 'Unmapped'}</span></p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button id="confirmAllMappings" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-black text-3xl py-8 rounded-3xl hover:from-emerald-600 hover:to-emerald-700 transition transform hover:scale-105 glow">
                            Confirm All & Run Full Resonator Analysis
                        </button>
                    </div>
                `;
                mappingSection.classList.remove('hidden');

                document.getElementById('confirmAllMappings').addEventListener('click', async () => {
                    status.textContent = 'Running full resonator analysis on all files...';
                    mappingSection.classList.add('hidden');

                    try {
                        const analyzePromises = fileData.map(async (f) => {
                            const analyzeForm = new FormData();
                            analyzeForm.append('key', f.key);
                            analyzeForm.append('mapping', JSON.stringify(f.mapping));

                            const analyzeRes = await fetch(`${BACKEND_URL}/analysis/analyze`, {
                                method: 'POST',
                                headers,
                                body: analyzeForm
                            });
                            if (!analyzeRes.ok) throw new Error(await analyzeRes.text());
                            const data = await analyzeRes.json();
                            return { filename: f.filename, leaks: data.leaks || {} };
                        });

                        const allResults = await Promise.all(analyzePromises);

                        status.textContent = 'Analysis Complete!';
                        status.className = 'text-emerald-400';

                        result.innerHTML = `
                            <div class="glass-card p-20 rounded-3xl glow">
                                <h2 class="text-6xl font-black mb-16 text-center">Resonator Profit Leak Analysis (${allResults.length} files)</h2>
                                <div class="space-y-20">
                                    ${allResults.map((res) => `
                                        <div class="bg-white/5 rounded-3xl p-12">
                                            <h3 class="text-4xl font-bold mb-8">${res.filename}</h3>
                                            <div class="grid gap-12 md:grid-cols-2 lg:grid-cols-4">
                                                ${Object.entries(res.leaks).map(([primitive, data]) => `
                                                    <div>
                                                        <h4 class="text-2xl font-semibold mb-4 capitalize">${primitive.replace('_', ' ')}</h4>
                                                        <ol class="space-y-3 text-lg">
                                                            ${data.top_items.slice(0, 5).map((item, i) => `
                                                                <li class="flex justify-between">
                                                                    <span>${item || 'Unknown'}</span>
                                                                    <span class="text-emerald-400">${data.scores[i]?.toFixed(2) || 'N/A'}</span>
                                                                </li>
                                                            `).join('')}
                                                        </ol>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        result.classList.remove('hidden');
                    } catch (err) {
                        console.error(err);
                        status.textContent = 'Error: ' + (err.message || 'Analysis failed');
                        status.className = 'text-red-400';
                    }
                });

            } catch (err) {
                console.error(err);
                status.textContent = 'Error: ' + (err.message || 'Failed');
                status.className = 'text-red-400';
            }
        });
    </script>
</body>
</html>